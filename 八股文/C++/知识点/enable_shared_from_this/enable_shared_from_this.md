# enable_shared_from_this

### é€šä¿—è§£é‡Šï¼š`enable_shared_from_this` æ˜¯ä»€ä¹ˆï¼Ÿ

æƒ³è±¡ä½ æœ‰ä¸€æ ‹æˆ¿å­ï¼ˆå¯¹è±¡ï¼‰ï¼Œæˆ¿å­è‡ªå·±éœ€è¦çŸ¥é“æˆ¿äº§è¯ï¼ˆ`shared_ptr`ï¼‰åœ¨å“ªé‡Œã€‚`enable_shared_from_this` å°±æ˜¯ç»™æˆ¿å­è£…äº†ä¸ªç‰¹æ®Šè£…ç½®ï¼Œè®©å®ƒèƒ½å®‰å…¨åœ°æ‹¿åˆ°è‡ªå·±çš„æˆ¿äº§è¯å¤å°ä»¶ã€‚

#### æ ¸å¿ƒä½œç”¨ï¼š
è®©å¯¹è±¡å†…éƒ¨èƒ½å®‰å…¨è·å–æŒ‡å‘è‡ªå·±çš„ `shared_ptr`ï¼Œé¿å…åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„æ™ºèƒ½æŒ‡é’ˆå¯¼è‡´å†…å­˜è¢«å¤šæ¬¡åˆ é™¤ã€‚

---

### ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿç›´æ¥çœ‹é—®é¢˜åœºæ™¯

```cpp
class Cat {
public
    void Meow() {
         å±é™©æ“ä½œï¼ç›´æ¥åˆ›å»ºæ–°shared_ptr
        stdshared_ptrCat badPtr(this);
    }
};

int main() {
    auto cat = stdmake_sharedCat();
    cat-Meow();  ç¾éš¾ï¼šä¸¤ä¸ªç‹¬ç«‹çš„shared_ptræŒ‡å‘åŒä¸€å¯¹è±¡
}
```
å½“ç¨‹åºç»“æŸæ—¶ï¼š
1. `cat` ææ„ â†’ åˆ é™¤ Cat å¯¹è±¡
2. `badPtr` ææ„ â†’ å†æ¬¡åˆ é™¤åŒä¸€å¯¹è±¡ï¼ â†’ ç¨‹åºå´©æºƒ ğŸ’¥

---

### æ­£ç¡®ä½¿ç”¨æ–¹å¼

```cpp
#include memory

 å…³é”®æ­¥éª¤ï¼šç»§æ‰¿ enable_shared_from_this
class SafeCat  public stdenable_shared_from_thisSafeCat {
public
    void SafeMeow() {
         å®‰å…¨è·å–æŒ‡å‘è‡ªå·±çš„shared_ptr
        stdshared_ptrSafeCat safePtr = shared_from_this();
         ç°åœ¨å¯ä»¥å®‰å…¨ä¼ é€’è¿™ä¸ªæŒ‡é’ˆäº†...
    }
};

int main() {
     å¿…é¡»ç”¨shared_ptråˆ›å»ºå¯¹è±¡ï¼ˆé‡è¦ï¼ï¼‰
    auto cat = stdmake_sharedSafeCat();
    cat-SafeMeow();  å®‰å…¨ï¼šæ‰€æœ‰æŒ‡é’ˆå…±äº«åŒä¸€ä»½è®¡æ•°
}
```

#### å·¥ä½œåŸç†å›¾è§£
```
             æ§åˆ¶å—
          +------------+
           å¼•ç”¨è®¡æ•° = 2 
           weakè®¡æ•° = 1 
          +-----â–²------+
                â”‚
                â”‚
+---------------â”¼------------------+
 SafeCat å¯¹è±¡                      
  ç»§æ‰¿ enable_shared_from_this     
  å†…éƒ¨éšè—çš„ weak_ptrâ—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+-----------------------------------+
         â–²              â–²
         â”‚              â”‚
         â”‚              â”‚
    mainä¸­çš„cat    SafeMeowä¸­çš„safePtr
```

---

### å¿…é¡»éµå®ˆçš„è§„åˆ™

1. å¿…é¡»å…¬æœ‰ç»§æ‰¿  
   ```cpp 
   class T  public stdenable_shared_from_thisT { ... }
   ```

2. å¯¹è±¡å¿…é¡»ç”± `shared_ptr` ç®¡ç†  
   é”™è¯¯ç¤ºä¾‹ï¼š
   ```cpp
   SafeCat localCat;  æ ˆå¯¹è±¡ï¼Œæœªç”¨shared_ptrç®¡ç†
   localCat.SafeMeow();  æŠ›å‡º stdbad_weak_ptr å¼‚å¸¸
   ```

3. ç¦æ­¢åœ¨æ„é€ å‡½æ•°å†…è°ƒç”¨  
   å¯¹è±¡æ„é€ å®Œæˆå‰æ§åˆ¶å—å°šæœªå»ºç«‹ï¼š
   ```cpp
   SafeCat() {
       shared_from_this();  é”™è¯¯ï¼ä¼šå´©æºƒ
   }
   ```

---

### å®é™…åº”ç”¨åœºæ™¯
å½“å¯¹è±¡éœ€è¦æŠŠè‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆä¼ ç»™å…¶ä»–ç»„ä»¶æ—¶ï¼š
```cpp
class GameCharacter 
     public stdenable_shared_from_thisGameCharacter 
{
public
    void JoinTeam() {
         æŠŠè‡ªèº«æŒ‡é’ˆä¼ ç»™é˜Ÿä¼ç³»ç»Ÿ
        TeamSystemRegister(shared_from_this());
    }
};

 ä½¿ç”¨
auto player = stdmake_sharedGameCharacter();
player-JoinTeam();   å®‰å…¨ä¼ é€’æ™ºèƒ½æŒ‡é’ˆ
```

---

### æ€»ç»“ï¼šæ–°æ‰‹è®°å¿†è¦ç‚¹

 è¦ç‚¹  è¯´æ˜ 
------------
 åšä»€ä¹ˆç”¨  **è®©å¯¹è±¡å†…éƒ¨èƒ½å®‰å…¨è·å–è‡ªå·±çš„ `shared_ptr`** 
 ä½•æ—¶ç”¨  å½“å¯¹è±¡éœ€è¦æŠŠè‡ªèº«æŒ‡é’ˆä¼ é€’ç»™å…¶ä»–ç»„ä»¶æ—¶ 
 æ€ä¹ˆç”¨  1. ç»§æ‰¿å®ƒbr2. ç”¨ `shared_from_this()` è·å–æŒ‡é’ˆbr3. å¯¹è±¡å¿…é¡»ç”± `shared_ptr` åˆ›å»º 
 ç¦æ­¢åœºæ™¯  1. æœªè¢« `shared_ptr` ç®¡ç†çš„å¯¹è±¡br2. æ„é€ å‡½æ•°å†…è°ƒç”¨ 
 é”™è¯¯ä»£ä»·  åŒé‡é‡Šæ”¾ â†’ ç¨‹åºå´©æºƒ 

 å°±åƒä½ ä¸èƒ½è‡ªå·±ç»™è‡ªå·±å‘æˆ¿äº§è¯ä¸€æ ·ï¼Œ`enable_shared_from_this` æ˜¯å¯¹è±¡è·å–åˆæ³•èº«ä»½è¯æ˜çš„å®‰å…¨é€šé“ã€‚